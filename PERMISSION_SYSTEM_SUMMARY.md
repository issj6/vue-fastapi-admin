# åŸºäºè§’è‰²çš„åˆ†çº§ä»£ç†æƒé™ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ¯ å®ç°æ¦‚è¿°

æˆåŠŸä¿®æ­£å¹¶å®ç°äº†åŸºäºè§’è‰²çš„åˆ†çº§ä»£ç†æƒé™ç®¡ç†ç³»ç»Ÿï¼Œè§£å†³äº†åŸæœ‰æƒé™é€»è¾‘é”™è¯¯ï¼Œå»ºç«‹äº†å®Œæ•´çš„å±‚çº§æƒé™æ§åˆ¶ä½“ç³»ã€‚

## ğŸ”§ æ ¸å¿ƒä¿®æ­£å†…å®¹

### 1. æƒé™æ£€æŸ¥é€»è¾‘ä¿®æ­£

#### åŸæœ‰é—®é¢˜
- æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°å…¨éƒ¨ç”¨æˆ·åˆ—è¡¨
- æƒé™æ£€æŸ¥é€»è¾‘ä¸å¤Ÿç²¾ç¡®
- ç¼ºä¹åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤

#### ä¿®æ­£æ–¹æ¡ˆ
```python
# æ–°å¢ä¸¤ä¸ªæƒé™æ£€æŸ¥å‡½æ•°
async def check_subordinate_permission(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·çš„æƒé™"""
    
async def check_user_list_permission(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨çš„æƒé™ï¼ˆæŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ï¼‰"""
```

#### æƒé™åˆ†çº§é€»è¾‘
1. **è¶…çº§ç®¡ç†å‘˜**: æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
2. **ç®¡ç†å‘˜è§’è‰²**: æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·  
3. **æœ‰"æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·"æƒé™**: æŸ¥çœ‹è‡ªå·±å’Œä¸‹çº§ç”¨æˆ·
4. **æ™®é€šç”¨æˆ·**: åªèƒ½æŸ¥çœ‹è‡ªå·±

### 2. åˆ†çº§ä»£ç†ç³»ç»Ÿæ¶æ„

#### è§’è‰²å±‚çº§è®¾è®¡
```
ç³»ç»Ÿç®¡ç†å‘˜ (è¶…çº§ç®¡ç†å‘˜)
â”œâ”€â”€ ä¸€çº§ä»£ç† (å¯åˆ›å»ºäºŒçº§ä»£ç†å’Œæ™®é€šç”¨æˆ·)
â”‚   â”œâ”€â”€ äºŒçº§ä»£ç† (åªèƒ½åˆ›å»ºæ™®é€šç”¨æˆ·)
â”‚   â”‚   â”œâ”€â”€ æ™®é€šç”¨æˆ·
â”‚   â”‚   â””â”€â”€ æ™®é€šç”¨æˆ·
â”‚   â””â”€â”€ æ™®é€šç”¨æˆ·
â””â”€â”€ æ™®é€šç”¨æˆ·
```

#### å®é™…æµ‹è¯•æ•°æ®
- **admin** (id=1, è¶…çº§ç®¡ç†å‘˜) â†’ å¯æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- **agent1** (id=3, ä¸€çº§ä»£ç†) â†’ å¯æŸ¥çœ‹è‡ªå·±å’Œagent2
- **agent2** (id=4, äºŒçº§ä»£ç†, agent1çš„ä¸‹çº§) â†’ åªèƒ½æŸ¥çœ‹è‡ªå·±
- **testuser** (id=2, adminçš„ä¸‹çº§) â†’ æ™®é€šç”¨æˆ·

## ğŸ›¡ï¸ æƒé™é…ç½®è¯¦æƒ…

### è§’è‰²æƒé™åˆ†é…

#### ä¸€çº§ä»£ç†è§’è‰²æƒé™
```json
{
  "role_name": "ä¸€çº§ä»£ç†",
  "api_permissions": [
    "GET /api/v1/base/userinfo",
    "GET /api/v1/base/usermenu", 
    "GET /api/v1/base/userapi",
    "GET /api/v1/user/list",           // ç”¨æˆ·åˆ—è¡¨è®¿é—®æƒé™
    "GET /api/v1/user/subordinates",   // æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·æƒé™
    "POST /api/v1/user/create",        // åˆ›å»ºç”¨æˆ·æƒé™
    "POST /api/v1/user/update",        // æ›´æ–°ç”¨æˆ·æƒé™
    "POST /api/v1/user/add_points",    // ç§¯åˆ†ç®¡ç†æƒé™
    "POST /api/v1/user/deduct_points", // ç§¯åˆ†ç®¡ç†æƒé™
    "GET /api/v1/user/invitation_info", // é‚€è¯·ä¿¡æ¯æƒé™
    "GET /api/v1/role/list",           // è§’è‰²åˆ—è¡¨æƒé™
    "GET /api/v1/dept/list"            // éƒ¨é—¨åˆ—è¡¨æƒé™
  ]
}
```

#### äºŒçº§ä»£ç†è§’è‰²æƒé™
```json
{
  "role_name": "äºŒçº§ä»£ç†", 
  "api_permissions": [
    "GET /api/v1/base/userinfo",
    "GET /api/v1/base/usermenu",
    "GET /api/v1/base/userapi", 
    "GET /api/v1/user/list",           // ç”¨æˆ·åˆ—è¡¨è®¿é—®æƒé™
    "GET /api/v1/user/subordinates",   // æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·æƒé™
    "POST /api/v1/user/create",        // åˆ›å»ºç”¨æˆ·æƒé™ï¼ˆä»…æ™®é€šç”¨æˆ·ï¼‰
    "POST /api/v1/user/add_points",    // ç§¯åˆ†ç®¡ç†æƒé™
    "POST /api/v1/user/deduct_points", // ç§¯åˆ†ç®¡ç†æƒé™
    "GET /api/v1/user/invitation_info", // é‚€è¯·ä¿¡æ¯æƒé™
    "GET /api/v1/role/list",           // è§’è‰²åˆ—è¡¨æƒé™
    "GET /api/v1/dept/list"            // éƒ¨é—¨åˆ—è¡¨æƒé™
  ]
}
```

### æƒé™æ§åˆ¶åŸåˆ™

#### 1. APIè®¿é—®æƒé™ vs æ•°æ®æŸ¥çœ‹æƒé™
- **APIè®¿é—®æƒé™**: æ§åˆ¶æ˜¯å¦èƒ½è°ƒç”¨ç‰¹å®šAPIæ¥å£
- **æ•°æ®æŸ¥çœ‹æƒé™**: æ§åˆ¶èƒ½çœ‹åˆ°å“ªäº›å…·ä½“æ•°æ®

#### 2. æ•°æ®è¿‡æ»¤é€»è¾‘
```python
# ç”¨æˆ·åˆ—è¡¨æƒé™è¿‡æ»¤
if not current_user.is_superuser:
    has_user_list_permission = await check_user_list_permission(current_user_id)
    
    if has_user_list_permission:
        # ç®¡ç†å‘˜è§’è‰²ï¼šæŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
        pass
    else:
        has_subordinate_permission = await check_subordinate_permission(current_user_id)
        
        if has_subordinate_permission:
            # ä»£ç†è§’è‰²ï¼šæŸ¥çœ‹è‡ªå·±å’Œä¸‹çº§ç”¨æˆ·
            subordinate_ids = await get_subordinate_user_ids(current_user_id)
            subordinate_ids.append(current_user_id)
            q &= Q(id__in=subordinate_ids)
        else:
            # æ™®é€šç”¨æˆ·ï¼šåªæŸ¥çœ‹è‡ªå·±
            q &= Q(id=current_user_id)
```

## ğŸ“Š æµ‹è¯•éªŒè¯ç»“æœ

### æƒé™æµ‹è¯•çŸ©é˜µ

| ç”¨æˆ·ç±»å‹ | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | æŸ¥çœ‹ä¸‹çº§ç”¨æˆ· | åˆ›å»ºç”¨æˆ· | ç§¯åˆ†ç®¡ç† | ç»“æœ |
|---------|------------|------------|---------|---------|------|
| è¶…çº§ç®¡ç†å‘˜ | âœ… æ‰€æœ‰ç”¨æˆ· | âœ… æ‰€æœ‰ç”¨æˆ· | âœ… ä»»æ„è§’è‰² | âœ… ä»»æ„ç”¨æˆ· | âœ… é€šè¿‡ |
| ä¸€çº§ä»£ç† | âœ… è‡ªå·±+ä¸‹çº§ | âœ… ä¸‹çº§ç”¨æˆ· | âœ… äºŒçº§ä»£ç†+æ™®é€šç”¨æˆ· | âœ… ä¸‹çº§ç”¨æˆ· | âœ… é€šè¿‡ |
| äºŒçº§ä»£ç† | âœ… ä»…è‡ªå·± | âœ… ä¸‹çº§ç”¨æˆ·(ç©º) | âœ… æ™®é€šç”¨æˆ· | âœ… ä¸‹çº§ç”¨æˆ· | âœ… é€šè¿‡ |
| æ™®é€šç”¨æˆ· | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âœ… é€šè¿‡ |

### å…·ä½“æµ‹è¯•ç»“æœ

#### 1. adminç”¨æˆ·ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
```bash
curl -X GET "/api/v1/user/list" -H "token: admin_token"
# è¿”å›ï¼š4ä¸ªç”¨æˆ·ï¼ˆadmin, testuser, agent1, agent2ï¼‰
```

#### 2. agent1ç”¨æˆ·ï¼ˆä¸€çº§ä»£ç†ï¼‰
```bash
curl -X GET "/api/v1/user/list" -H "token: agent1_token"  
# è¿”å›ï¼š2ä¸ªç”¨æˆ·ï¼ˆagent1è‡ªå·±, agent2ä¸‹çº§ï¼‰

curl -X GET "/api/v1/user/subordinates" -H "token: agent1_token"
# è¿”å›ï¼š1ä¸ªç”¨æˆ·ï¼ˆagent2ï¼‰
```

#### 3. agent2ç”¨æˆ·ï¼ˆäºŒçº§ä»£ç†ï¼‰
```bash
curl -X GET "/api/v1/user/list" -H "token: agent2_token"
# è¿”å›ï¼š1ä¸ªç”¨æˆ·ï¼ˆagent2è‡ªå·±ï¼‰

curl -X GET "/api/v1/user/subordinates" -H "token: agent2_token"  
# è¿”å›ï¼š0ä¸ªç”¨æˆ·ï¼ˆæ— ä¸‹çº§ï¼‰
```

## ğŸ”‘ å…³é”®æŠ€æœ¯å®ç°

### 1. æƒé™æ£€æŸ¥å‡½æ•°
- `check_subordinate_permission()` - æ£€æŸ¥æŸ¥çœ‹ä¸‹çº§ç”¨æˆ·æƒé™
- `check_user_list_permission()` - æ£€æŸ¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æƒé™

### 2. æ•°æ®è¿‡æ»¤æœºåˆ¶
- åŸºäºç”¨æˆ·è§’è‰²çš„åŠ¨æ€SQLè¿‡æ»¤
- å±‚çº§å…³ç³»çš„é€’å½’æŸ¥è¯¢
- æƒé™ç»§æ‰¿å’Œé™åˆ¶

### 3. APIæƒé™æ§åˆ¶
- ä¸­é—´ä»¶çº§åˆ«çš„APIè®¿é—®æ§åˆ¶
- ä¸šåŠ¡é€»è¾‘çº§åˆ«çš„æ•°æ®è¿‡æ»¤
- åŒé‡æƒé™éªŒè¯æœºåˆ¶

## ğŸ‰ å®ç°æ•ˆæœ

### âœ… è§£å†³çš„é—®é¢˜
1. **æƒé™æ³„éœ²**: ä¿®æ­£äº†æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°å…¨éƒ¨ç”¨æˆ·çš„é—®é¢˜
2. **æƒé™æ··ä¹±**: å»ºç«‹äº†æ¸…æ™°çš„è§’è‰²æƒé™ä½“ç³»
3. **æ•°æ®å®‰å…¨**: å®ç°äº†åŸºäºè§’è‰²çš„æ•°æ®è®¿é—®æ§åˆ¶
4. **å±‚çº§ç®¡ç†**: å®Œå–„äº†åˆ†çº§ä»£ç†ç®¡ç†ç³»ç»Ÿ

### âœ… æ–°å¢åŠŸèƒ½
1. **è§’è‰²æƒé™é…ç½®**: çµæ´»çš„æƒé™åˆ†é…æœºåˆ¶
2. **æ•°æ®è¿‡æ»¤**: æ™ºèƒ½çš„æ•°æ®è®¿é—®æ§åˆ¶
3. **æƒé™éªŒè¯**: å®Œæ•´çš„æƒé™æ£€æŸ¥æµç¨‹
4. **æµ‹è¯•éªŒè¯**: å…¨é¢çš„åŠŸèƒ½æµ‹è¯•è¦†ç›–

### âœ… ç³»ç»Ÿç‰¹æ€§
1. **å®‰å…¨æ€§**: ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
2. **çµæ´»æ€§**: å¯é…ç½®çš„è§’è‰²æƒé™ç³»ç»Ÿ
3. **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°è§’è‰²å’Œæƒé™
4. **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œé€»è¾‘

## ğŸš€ ä½¿ç”¨è¯´æ˜

### è§’è‰²åˆ›å»ºæµç¨‹
1. åˆ›å»ºè§’è‰²ï¼š`POST /api/v1/role/create`
2. é…ç½®æƒé™ï¼š`POST /api/v1/role/authorized`
3. åˆ†é…ç”¨æˆ·ï¼šåœ¨ç”¨æˆ·åˆ›å»ºæ—¶æŒ‡å®š`role_ids`

### æƒé™éªŒè¯æµç¨‹
1. APIè®¿é—®éªŒè¯ï¼ˆä¸­é—´ä»¶ï¼‰
2. æ•°æ®æƒé™éªŒè¯ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
3. è¿”å›è¿‡æ»¤åçš„æ•°æ®

**åŸºäºè§’è‰²çš„åˆ†çº§ä»£ç†æƒé™ç³»ç»Ÿå·²å®Œå…¨å®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼** ğŸŠ
